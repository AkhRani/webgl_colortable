<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Web GL Color Lookup</title>
        <script src="coloradjuster.js"></script>
        <script>
          adjuster = new ColorAdjuster();
          var testPattern = false;
          var data = null;
          var useData = false;
          var bgImage = null;
          var overlayImage = null;
          var lut = new Uint8Array(3 * 256);

          function start() {
            var canvas = document.getElementById("glcanvas");
            adjuster.init(canvas);

            overlayImage = new Image();
            overlayImage.src = "overlay.png";

            bgImage = new Image();
            bgImage.src = "image_1.jpg";

            onGradientButton(null);
            redrawImage();

            document.getElementById("windowControl").
              addEventListener("input", onSettingsChanged, false);
            document.getElementById("levelControl").
              addEventListener("input", onSettingsChanged, false);
            document.getElementById("gradientButton").
              addEventListener("click", onGradientButton, false);
            document.getElementById("NPOTEvenButton").
              addEventListener("click", onNpotEvenButton, false);
            document.getElementById("TestPatternButton").
              addEventListener("click", onTestPatternButton, false);
            document.getElementById("ImageButton").
              addEventListener("click", onImageButton, false);
            document.getElementById("NPOTOddButton").
              addEventListener("click", onNpotOddButton, false);
            document.getElementById("invertCheckbox").
              addEventListener("change", onSettingsChanged, false);
            document.getElementById("overlayCheckbox").
              addEventListener("change", onSettingsChanged, false);
            document.getElementById("autoAlphaCheckbox").
              addEventListener("change", onSettingsChanged, false);
            document.getElementById("overlaySlider").
              addEventListener("input", onSettingsChanged, false);
          }

          function redrawImage() {
            adjuster.clear();

            var windowControl = document.getElementById("windowControl");
            var levelControl =  document.getElementById("levelControl");

            // Rescale window width from 256 to 4096
            var width = windowControl.value * 16;

            // Determine the highest and lowest possible center values
            var lowestCenter = width / 2;
            var highestCenter = 4096 - (width / 2);
            var centerRange = (highestCenter - lowestCenter);
            var relativeCenter = levelControl.value / 256.0;
            var center = relativeCenter * centerRange + lowestCenter;

            adjuster.setWindow(width, center, 12, [128, 128, 0]);

            if (testPattern) {
              adjuster.setColorTable(lut);
            }

            var invertControl = document.getElementById("invertCheckbox");
            if (useData) {
              // TODO:  Support npot
              adjuster.setData(data, 128, 64);
            }
            else {
              adjuster.setImage(bgImage);
            }
            adjuster.draw(invertControl.checked);

            var overlayCheckbox = document.getElementById("overlayCheckbox");
            if (overlayCheckbox.checked) { 
              var overlaySlider = document.getElementById("overlaySlider");
              var globalAlpha = overlaySlider.value / 100.;

              var autoAlphaCheckbox = document.getElementById("autoAlphaCheckbox");
              var autoAlpha = autoAlphaCheckbox.checked;

              adjuster.setImage(overlayImage);
              adjuster.setAlpha(globalAlpha, autoAlpha);
              adjuster.draw(invertControl.checked);
            }

          }

          function onSettingsChanged(evt) {
            redrawImage();
          }

          function onGradientButton(evt) {
            data = new Uint16Array(128*64);
            for (i = 0; i < 128*64; i++) {
              data[i] = i;
            }
            useData = true;
            testPattern = false;
            redrawImage();
          }

          function onNpotEvenButton(evt) {
            onNpot(14);
          }

          function onNpotOddButton(evt) {
            onNpot(13);
          }

          function onNpot(size) {
            var data = new Uint16Array(size * size);
            for (i = 0; i < size * size; i++) {
              data[i] = 0;
            }
            data[0] = 2048;
            data[size - 1] = 2048;
            data[size * (size-1)] = 2048;
            data[size * size - 1] = 2048;

            adjuster.setImageData(data, size, size);
            adjuster.drawImage();
          }

          function onTestPatternButton() {
            for (i = 0; i < 256; i++) {
              if ((i & 1) != 0) {
                lut[i*3] = 255;
                lut[i*3 + 1] = 0;
              }
              else {
                lut[i*3] = 0;
                lut[i*3 + 1] = 255;
              }
              lut[i*3 + 2] = 0;
            }
            testPattern = true;
            redrawImage();
          }

          function onImageButton() {
            useData = false;
            redrawImage();
          }

        </script>
    </head>

    <body onload="start()">
      <canvas id="glcanvas" width="1024" height="512" style="background: red;">
      Missing canvas support
      </canvas>
      <br/>
      <input id="windowControl" type="range" min="3" max="256" value="256" >Window<br/>
      <input id="levelControl" type="range" min="0" max="255" value="128" >Level<br/>
      <input id="TestPatternButton" style="xxdisplay:none" type="button" value="Test Pattern"><br/>
      <input id="gradientButton" type="button" value="Gradient"><br/>
      <input id="NPOTEvenButton" type="button" value="NPOT Even"><br/>
      <input id="NPOTOddButton" type="button" value="NPOT Odd"><br/>
      <input id="ImageButton" type="button" value="Image">  Note:  Set window / level to the left to show 0-255 values<br/>
      <input id="invertCheckbox" type="checkbox" value="inverted">Invert<br/>
      <input id="overlayCheckbox" type="checkbox" value="inverted">Enable Overlay<br/>
      <input id="autoAlphaCheckbox" type="checkbox" value="inverted">Enable Auto-alpha<br/>
      <input id="overlaySlider" type="range" min="0" max="100" value="100" >Adjust Overlay Alpha<br/>
    </body>

</html>

