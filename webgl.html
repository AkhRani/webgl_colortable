<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Web GL Color Lookup</title>
        <script src="coloradjuster.js"></script>
        <script>
          adjuster = new ColorAdjuster();
          var testPattern = false;

          function start() {
            var canvas = document.getElementById("glcanvas");
            adjuster.init(canvas);

            overlayImage = new Image();
            overlayImage.onload = function () {
              adjuster.setOverlayImage(overlayImage);
            }
            overlayImage.src = "overlay.png";

            readWindowAndOverlayControls();
            onGradientButton(null);

            document.getElementById("windowControl").
              addEventListener("input", onSettingsChanged, false);
            document.getElementById("levelControl").
              addEventListener("input", onSettingsChanged, false);
            document.getElementById("gradientButton").
              addEventListener("click", onGradientButton, false);
            document.getElementById("NPOTEvenButton").
              addEventListener("click", onNpotEvenButton, false);
            document.getElementById("TestPatternButton").
              addEventListener("click", onTestPatternButton, false);
            document.getElementById("ImageButton").
              addEventListener("click", onImageButton, false);
            document.getElementById("NPOTOddButton").
              addEventListener("click", onNpotOddButton, false);
            document.getElementById("invertCheckbox").
              addEventListener("change", onSettingsChanged, false);
            document.getElementById("overlayCheckbox").
              addEventListener("change", onSettingsChanged, false);
            document.getElementById("autoAlphaCheckbox").
              addEventListener("change", onSettingsChanged, false);
            document.getElementById("overlaySlider").
              addEventListener("input", onSettingsChanged, false);
          }

          function readWindowAndOverlayControls() {
            var windowControl = document.getElementById("windowControl");
            var levelControl =  document.getElementById("levelControl");

            // Rescale window width from 256 to 4096
            var width = windowControl.value * 16;

            // Determine the highest and lowest possible center values
            var lowestCenter = width / 2;
            var highestCenter = 4096 - (width / 2);
            var centerRange = (highestCenter - lowestCenter);
            var relativeCenter = levelControl.value / 256.0;
            var center = relativeCenter * centerRange + lowestCenter;

            adjuster.setWindow(width, center, 12, [128, 128, 0]);

            // Overlay settings
            var overlayCheckbox = document.getElementById("overlayCheckbox");
            adjuster.enableOverlay(overlayCheckbox.checked);

            var autoAlphaCheckbox = document.getElementById("autoAlphaCheckbox");
            adjuster.enableOverlayAutoAlpha(autoAlphaCheckbox.checked);

            var overlaySlider = document.getElementById("overlaySlider");
            adjuster.setOverlayAlpha(overlaySlider.value / 100.);
          }

          function redrawImage() {
            var invertControl = document.getElementById("invertCheckbox");
            adjuster.drawImage(invertControl.checked);
          }

          function onSettingsChanged(evt) {
            readWindowAndOverlayControls();
            if (testPattern) {
              onGradientButton(null);
            }
            else {
              redrawImage();
            }
          }

          function onGradientButton(evt) {
            var data = new Uint16Array(128*64);
            for (i = 0; i < 128*64; i++) {
              data[i] = i;
            }
            adjuster.setImageData(data, 128, 64);
            redrawImage();
          }

          function onNpotEvenButton(evt) {
            onNpot(14);
          }

          function onNpotOddButton(evt) {
            onNpot(13);
          }

          function onNpot(size) {
            var data = new Uint16Array(size * size);
            for (i = 0; i < size * size; i++) {
              data[i] = 0;
            }
            data[0] = 2048;
            data[size - 1] = 2048;
            data[size * (size-1)] = 2048;
            data[size * size - 1] = 2048;

            adjuster.setImageData(data, size, size);
            adjuster.drawImage();
          }

          function onTestPatternButton() {
            var ct = new Uint8Array(3 * 65536);
            for (i = 0; i < 65536; i++) {
              if ((i & 1) != 0) {
                ct[i*3] = 255;
                ct[i*3 + 1] = 0;
              }
              else {
                ct[i*3] = 0;
                ct[i*3 + 1] = 255;
              }
              ct[i*3 + 2] = 0;
            }
            adjuster.setColorTable(ct);
            var data = new Uint16Array(256*256);
            for (i = 0; i < 256*256; i++) {
              data[i] = i;
            }
            adjuster.setImageData(data, 256, 256);
            testPattern = true;
            redrawImage();
          }

          function onImageButton() {
            myImage = new Image();
            myImage.onload = function () {
              adjuster.setImage(myImage);
              redrawImage();
            }
            myImage.src = "image_1.jpg";
          }

        </script>
    </head>

    <body onload="start()">
      <canvas id="glcanvas" width="1024" height="512" style="background: red;">
      Missing canvas support
      </canvas>
      <br/>
      <input id="windowControl" type="range" min="3" max="256" value="256" >Window<br/>
      <input id="levelControl" type="range" min="0" max="255" value="128" >Level<br/>
      <input id="TestPatternButton" style="display:none" type="button" value="Test Pattern"><br/>
      <input id="gradientButton" type="button" value="Gradient"><br/>
      <input id="NPOTEvenButton" type="button" value="NPOT Even"><br/>
      <input id="NPOTOddButton" type="button" value="NPOT Odd"><br/>
      <input id="ImageButton" type="button" value="Image">  Note:  Set window / level to the left to show 0-255 values<br/>
      <input id="invertCheckbox" type="checkbox" value="inverted">Invert<br/>
      <input id="overlayCheckbox" type="checkbox" value="inverted">Enable Overlay<br/>
      <input id="autoAlphaCheckbox" type="checkbox" value="inverted">Enable Auto-alpha<br/>
      <input id="overlaySlider" type="range" min="0" max="100" value="100" >Adjust Overlay Alpha<br/>
    </body>

</html>

